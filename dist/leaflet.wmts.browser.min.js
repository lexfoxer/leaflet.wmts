L.TileLayer.WMTS=L.TileLayer.extend({defaultWmtsParams:{service:"WMTS",request:"GetTile",version:"1.0.0",layer:"",style:"",tilematrixset:"",format:"image/jpeg"},initialize(t,i){this._url=t;const e={};Object.keys(i).forEach(t=>e[t.toLowerCase()]=i[t]);const s=L.extend({},this.defaultWmtsParams),r=e.tileSize||this.options.tileSize;e.detectRetina&&L.Browser.retina?(s.width=2*r,s.height=2*r):(s.width=r,s.height=r);for(const t in e)s.hasOwnProperty(t)&&"matrixIds"!==t&&(s[t]=e[t]);this.wmtsParams=s,this.matrixIds=i.matrixIds||this.getDefaultMatrix(),L.setOptions(this,i)},onAdd(t){this._crs=this.options.crs||t.options.crs,L.TileLayer.prototype.onAdd.call(this,t)},getTileUrl(t){const i=this.options.tileSize,e=t.multiplyBy(i);e.x+=1,e.y-=1;const s=e.add(new L.Point(i,i)),r=this._tileZoom,n=this._crs.project(this._map.unproject(s,r)),o=this._crs.project(this._map.unproject(e,r)),a=n.x-o.x,h=this.matrixIds[r].identifier,m=`${this.wmtsParams.tilematrixset}:${h}`,l=this.matrixIds[r].topLeftCorner.lng,c=this.matrixIds[r].topLeftCorner.lat,d=Math.floor((o.x-l)/a),f=-Math.floor((o.y-c)/a),p=L.Util.template(this._url,{s:this._getSubdomain(t)});return`${p}${L.Util.getParamString(this.wmtsParams,p)}`+`&tilematrix=${m}&tilerow=${f}&tilecol=${d}`},setParams(t,i){return L.extend(this.wmtsParams,t),i||this.redraw(),this},getDefaultMatrix(){const t=new Array(22);for(let i=0;i<22;i++)t[i]={identifier:String(i),topLeftCorner:new L.LatLng(20037508.3428,-20037508.3428)};return t}});
